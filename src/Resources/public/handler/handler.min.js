!function(t,e){"function"==typeof define&&define.amd?define([],e(t)):"object"==typeof exports?module.exports=e(t):t.ContaoFineUploader=e(t)}("undefined"!=typeof global?global:this.window||this.global,function(t){"use strict";function e(t,e){this.container=t,e=e||{},this.settings=JSON.parse(JSON.stringify(i));for(var n in e)e.hasOwnProperty(n)&&(this.settings[n]=e[n]);this.initEnvironment(),this.bindFormEventListeners(),this.currentValue=this.field.value,this.submitForm=!0}var i={ajaxActionName:"fineuploader_upload",ajaxContainerSelector:'[data-fineuploader="ajax-container"]',deleteButtonsSelector:'[data-fineuploader="delete"]',fieldSelector:'[data-fineuploader="field"]',itemSelector:'[data-fineuploader="item"]',uploaderSelector:'[data-fineuploader="uploader"]',configCallback:null};return e.prototype={initEnvironment:function(){this.ajaxContainer=this.container.querySelector(this.settings.ajaxContainerSelector),this.deleteButtons=this.container.querySelectorAll(this.settings.deleteButtonsSelector),this.field=this.container.querySelector(this.settings.fieldSelector),this.items=this.container.querySelectorAll(this.settings.itemSelector),this.uploader=this.container.querySelector(this.settings.uploaderSelector),this.bindDeleteEventListeners.apply(this)},initFineUploader:function(){var e={element:this.uploader,debug:!!this.settings.debug,request:{endpoint:t.location.href,inputName:this.field.name+"_fineuploader",params:{action:this.settings.ajaxActionName,name:this.field.name,REQUEST_TOKEN:this.field.form.querySelector('input[name="REQUEST_TOKEN"]').value}},failedUploadTextDisplay:{mode:"custom",maxChars:1e3,responseProperty:"error"},callbacks:{onValidateBatch:this.onValidateBatch.bind(this),onStatusChange:this.onStatusChange.bind(this),onComplete:this.onComplete.bind(this)}};this.settings.maxConnections&&(e.maxConnections=this.settings.maxConnections),this.settings.chunking&&(e.chunking={enabled:!0,partSize:this.settings.chunkSize,concurrent:!!this.settings.concurrent}),(this.settings.extensions||this.settings.minSizeLimit||this.settings.sizeLimit)&&(e.validation={},this.settings.extensions&&(e.validation.allowedExtensions=this.settings.extensions),this.settings.minSizeLimit&&(e.validation.minSizeLimit=this.settings.minSizeLimit),this.settings.sizeLimit&&(e.validation.sizeLimit=this.settings.sizeLimit)),this.settings.uploadButtonTitle&&(e.text={fileInputTitle:this.settings.uploadButtonTitle}),"function"==typeof this.settings.configCallback&&this.settings.configCallback(e),this.fineUploader=new qq.FineUploader(e)},setAjaxContainerContent:function(t){this.ajaxContainer.innerHTML=t,this.initEnvironment()},bindDeleteEventListeners:function(){var t=this;Array.from(t.deleteButtons).forEach(function(e){e.addEventListener("click",function(e){e.preventDefault(),t.deleteFile(this.dataset.deleteId)})})},bindFormEventListeners:function(){this.field.form.addEventListener("submit",function(t){this.submitForm||t.preventDefault()}.bind(this))},onValidateBatch:function(t){var e=""===this.currentValue?0:this.currentValue.split(",").length;return 1==this.settings.limit&&1==t.length&&1==e&&(e=0,this.currentValue="",this.fineUploader.clearStoredFiles()),!(this.settings.limit>0&&this.settings.limit<e+t.length)||(this.fineUploader._batchError(this.fineUploader._options.messages.tooManyItemsError.replace(/\{netItems\}/g,e+t.length).replace(/\{itemLimit\}/g,this.settings.limit)),!1)},onStatusChange:function(){this.submitForm=0===this.fineUploader.getInProgress(),Array.from(document.querySelectorAll('[type="submit"]')).forEach(function(t){t.form===this.field.form&&(t.disabled=!this.submitForm)}.bind(this))},onComplete:function(t,e,i){i.success&&(i.file&&(this.currentValue=(this.currentValue.length?this.currentValue+",":"")+i.file),0===this.fineUploader.getInProgress()&&(this.field.value=this.currentValue))},deleteFile:function(t){var e,i=this.currentValue.split(",");for(e=0;e<i.length;e++)if(i[e]===t){i.splice(e,1);break}for(this.currentValue=i.join(","),this.field.value=this.currentValue,e=0;e<this.items.length;e++){var n=this.items[e];if(n.dataset.itemId===t){n.parentElement.removeChild(n);break}}}},e});