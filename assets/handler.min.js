/**
 * fineuploader extension for Contao Open Source CMS
 *
 * @copyright  Copyright (c) 2008-2014, terminal42 gmbh
 * @author     terminal42 gmbh <info@terminal42.ch>
 * @license    http://opensource.org/licenses/lgpl-3.0.html LGPL
 * @link       http://github.com/terminal42/contao-fineuploader
 */
var ContaoFineUploader={};(function(){"use strict";function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}var e="";ContaoFineUploader.init=function(t,i,s){e=document.getElementById("ctrl_"+i.field).value;var o=[];if(i.prefix){o=n(i.prefix)}var u={element:t,debug:i.debug?true:false,multiple:i.multiple?true:false,request:{endpoint:window.location.href,inputName:i.field+"_fineuploader",params:{action:"fineuploader_upload",name:i.field,prefix:i.prefix!==undefined&&i.prefix!=""?i.prefix:"",REQUEST_TOKEN:i.request_token}},chunking:{enabled:i.chunking?true:false,partSize:i.chunkSize},failedUploadTextDisplay:{mode:"custom",maxChars:1e3,responseProperty:"error"},validation:{allowedExtensions:i.extensions,sizeLimit:i.sizeLimit},text:{formatProgress:i.labels.text.formatProgress,failUpload:i.labels.text.failUpload,waitingForResponse:i.labels.text.waitingForResponse,paused:i.labels.text.paused},messages:{tooManyFilesError:i.labels.messages.tooManyFilesError,unsupportedBrowser:i.labels.messages.unsupportedBrowser,prefixFieldError:i.labels.messages.prefixFieldError},retry:{autoRetryNote:i.labels.retry.autoRetryNote},deleteFile:{confirmMessage:i.labels.deleteFile.confirmMessage,deletingStatusText:i.labels.deleteFile.deletingStatusText,deletingFailedText:i.labels.deleteFile.deletingFailedText},paste:{namePromptMessage:i.labels.paste.namePromptMessage},callbacks:{onValidateBatch:function(t){var n=e==""?0:e.split(",").length;if(i.limit>0&&i.limit<n+t.length){this._batchError(this._options.messages.tooManyItemsError.replace(/\{netItems\}/g,n+t.length).replace(/\{itemLimit\}/g,i.limit));return false}},onUpload:function(){if(i.backend){AjaxRequest.displayBox(Contao.lang.loading+" â€¦")}},onSubmit:function(e,t){this._options.request.params.prefix=i.prefix;if(o==undefined||o.length==0){return true}else{var n=true;for(a=0;a<o.length;a++){if(o[a]!==undefined){if(o[a].value==undefined||o[a].value==""){this._batchError(this._options.messages.prefixFieldError.replace(/\{prefixField\}/g,r(o[a].name)));n=false}else{this._options.request.params.prefix=this._options.request.params.prefix.replace("##"+o[a].name+"##",o[a].value)}}else{return false}}if(!n)return false;else return true}},onComplete:function(t,n,r){if(!r.success){if(i.backend){AjaxRequest.hideBox()}return}if(r.file){e=(e.length?e+",":"")+r.file}if(this.getInProgress()>0){return}if(i.backend){(new Request.Contao({field:document.getElementById("ctrl_"+i.field),evalScripts:false,onSuccess:function(e,t){document.getElementById("ctrl_"+i.field).getParent("div").set("html",t.content);t.javascript&&Browser.exec(t.javascript);AjaxRequest.hideBox();window.fireEvent("ajax_change")}})).post({action:"fineuploader_reload",name:i.field,value:e,REQUEST_TOKEN:i.request_token})}else{document.getElementById("ctrl_"+i.field).value=e}}}};for(var a in s){u[a]=s[a]}return new qq.FineUploader(u)};ContaoFineUploader.deleteItem=function(e,n){var r=e.parentNode;var i=r.getAttribute("data-id");t(document.getElementById("ctrl_"+n),i);r.parentNode.removeChild(r)};ContaoFineUploader.makeSortable=function(e,t){var n;var r=(new Sortables(document.getElementById(e),{contstrain:true,opacity:.6})).addEvent("complete",function(){var r=[],s=document.getElementById(e).getChildren("li");for(n=0;n<s.length;n++){r.push(s[n].get("data-id"))}document.getElementById(t).value=r.join(",")});r.fireEvent("complete")};var t=function(t,n){var r=t.value.split(",");var i;for(i=0;i<r.length;i++){if(r[i]==n){r.splice(i,1);break}}e=r.join(",");t.value=e};var n=function(e){var t=e.match(/##[^#]+##/g);var n=[];t.forEach(function(e){n.push(document.getElementsByName(e.replace(/##/g,""))[0])});if(n.length==0)return undefined;else return n}})()